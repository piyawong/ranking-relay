generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BalanceSnapshot {
  id            String   @id
  timestamp     DateTime @default(now())
  pid           Int?
  onchain_rlb   Decimal  @db.Decimal(20, 8)
  onchain_usdt  Decimal  @db.Decimal(20, 8)
  onsite_rlb    Decimal  @db.Decimal(20, 8)
  onsite_usd    Decimal  @db.Decimal(20, 8)
  created_at    DateTime @default(now())
  rlb_price_usd Decimal? @db.Decimal(20, 8)

  @@index([created_at])
  @@index([timestamp])
}

model Block {
  id                     String        @id
  block_number           Int           @unique
  origin                 String?
  bloxroute_timestamp    DateTime?
  created_at             DateTime      @default(now())
  updated_at             DateTime
  block_hash             String?
  is_win_bloxroute       Boolean?
  time_difference_ms     Int?
  execution_block_number Int?
  mev_block_value        String?
  mev_builder_pubkey     String?
  mev_relay              String?
  RelayDetail            RelayDetail[]

  @@index([block_hash])
  @@index([block_number])
  @@index([block_number(sort: Desc), origin])
  @@index([execution_block_number])
  @@index([is_win_bloxroute])
  @@index([mev_relay])
  @@index([origin, bloxroute_timestamp, is_win_bloxroute])
}

model RelayDetail {
  id                String   @id
  block_id          String
  relay_name        String
  latency           Decimal  @db.Decimal(10, 2)
  loss              Decimal  @db.Decimal(5, 2)
  arrival_order     Int
  arrival_timestamp DateTime
  ranking_score     Decimal  @db.Decimal(10, 2)
  created_at        DateTime @default(now())
  Block             Block    @relation(fields: [block_id], references: [id], onDelete: Cascade)

  @@index([arrival_timestamp])
  @@index([block_id, arrival_order])
  @@index([block_id])
  @@index([ranking_score])
  @@index([relay_name])
}

model RelayLiveData {
  id              String   @id
  node_id         String   @unique
  mesh_peer_count Int      @default(0)
  mesh_peers      Json?
  peer_count      Int      @default(0)
  peers           Json?
  trusted_peers   Json?
  config          Json?
  health_status   String?
  discovery_stats Json?
  last_error      String?
  is_online       Boolean  @default(false)
  updated_at      DateTime
  created_at      DateTime @default(now())

  @@index([is_online])
  @@index([node_id])
  @@index([updated_at])
}

model RelayNode {
  id          String   @id
  name        String
  tag         String?
  description String?
  latitude    Decimal  @db.Decimal(10, 7)
  longitude   Decimal  @db.Decimal(10, 7)
  location    String?
  country     String?
  status      String   @default("active")
  endpoint    String?
  created_at  DateTime @default(now())
  updated_at  DateTime
  port        Int      @default(5052)

  @@index([country])
  @@index([name])
  @@index([status])
  @@index([tag])
}

model RelayStatistics {
  id                  String   @id
  relay_name          String   @unique
  total_blocks        Int      @default(0)
  avg_latency         Decimal  @db.Decimal(10, 2)
  avg_loss            Decimal  @db.Decimal(5, 2)
  first_arrival_count Int      @default(0)
  last_updated        DateTime

  @@index([relay_name])
}

model Trade {
  id                    String   @id
  trade_number          Int?     @unique
  timestamp             DateTime
  trigger_category      String
  trigger_type          String
  block_number          Int?
  initial_reserves_rlb  Decimal  @db.Decimal(20, 8)
  trade_amount_rlb      Decimal  @db.Decimal(20, 8)
  api_call_duration_ms  Decimal? @db.Decimal(10, 2)
  opponent              Boolean  @default(false)
  priority_gwei         Decimal? @db.Decimal(10, 3)
  opponent_trades_count Int?
  opponent_time_gap_ms  Decimal? @db.Decimal(10, 2)
  trade_logs            String[] @default([])
  win                   Boolean?
  created_at            DateTime @default(now())
  updated_at            DateTime
  trade_id              String?  @unique
  direction             String?
  onchain_usd_value     Decimal? @db.Decimal(20, 8)
  step1_action          String?
  step1_usd_value       Decimal? @db.Decimal(20, 8)
  tx_hash               String?
  gas_used_usd          Decimal? @db.Decimal(20, 8)
  onsite_value_usd      Decimal? @db.Decimal(20, 8)
  onsite_value_with_fee Decimal? @db.Decimal(20, 8)
  profit_with_gas_usd   Decimal? @db.Decimal(20, 8)
  raw_profit_usd        Decimal? @db.Decimal(20, 8)

  @@index([block_number])
  @@index([opponent])
  @@index([timestamp])
  @@index([trade_id])
  @@index([trade_number])
  @@index([trigger_category])
  @@index([trigger_type])
  @@index([tx_hash])
  @@index([win])
}

model ValidatorEntity {
  id                 String   @id
  validator_index    Int      @unique
  entity_name        String?
  pool_name          String?
  withdrawal_address String?
  activation_epoch   Int?
  exit_epoch         Int?
  last_fetched       DateTime @default(now())
  created_at         DateTime @default(now())
  updated_at         DateTime

  @@index([entity_name])
  @@index([validator_index])
}

model VisitorLog {
  id         String   @id
  ip         String
  country    String?
  city       String?
  path       String?
  user_agent String?
  created_at DateTime @default(now())

  @@index([country])
  @@index([created_at])
  @@index([ip])
}
